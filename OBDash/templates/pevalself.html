{% extends 'base.html' %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<div class="evaluation-container">
    <div class="back-button-container">
        <a href="{% url 'dashboard' %}" class="back-button">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <h1 class="domain-title">Self-Help Domain</h1>
    
    <!-- Include the domain navigation -->
    {% include 'domain_nav.html' with active_domain='self' %}
    
    <div class="evaluation-table">
        <table>
            <thead>
                <tr>
                    <th class="self-help-col">Self-Help</th>
                    <th class="material-col">Material/Procedure</th>
                    <th class="eval-col">1st Eval</th>
                    <th class="eval-col">2nd Eval</th>
                    <th class="eval-col">3rd Eval</th>
                    <th class="comments-col">Comments</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1. Feeding sub-domain</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>2. Feed self using fingers to eat non-hands with spoon</td>
                    <td>Automatically credit if child eats without spillage. Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>3. Feed self using spoon without spillage</td>
                    <td>Automatically credit if child eats without spillage. Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>4. Feed self using fingers without spillage</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>5. Feed self using spoon without spillage</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>6. Eats with head held for spoon-feeding during any meal</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>7. Gets drink for self-unassisted</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>8. Pours from pitcher without spillage</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>9. Volunteers to help younger siblings/family members when no adult is around</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>10. Dressing sub-domain<br>Self-dresses after being dressed (e.g., raises arms or lift legs)</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>11. Pulls down preferred short pants</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>12. Removes sando</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>13. Dresses without assistance except for buttoning and tying</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>14. Toilet Training sub-domain<br>Informs adult only after he has already urinated (wash) or moved has bowels (pooped) in his underpants</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>15. Informs the adult of need to urinate (pee) or move bowels (poop) ahead of time such as through place (e.g., comfort room)</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>16. Goes to the designated place to urinate (pee) or move bowels (poop) but sometimes still does this in his underpants</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>17. Goes to the designated place to urinate (pee) or move bowels (poop) and never does this in his underpants</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>18. Wipes/cleans self after a bowel movement (poop)</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>19. Bathing sub-domain<br>Participates when bathing (e.g., putting on soap)</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>20. Bathes without any help</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>--</td>
                    <td colspan="1" class="total-row">TOTAL SCORE</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="submit-button-container">
        <button type="button" class="submit-button">
            <i class="fas fa-save"></i> Save Evaluation
        </button>
    </div>
</div>

<style>
.back-button-container {
    margin-bottom: 1rem;
}

.back-button {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background-color: #2d6a4f;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    transition: background-color 0.3s ease;
    font-weight: 500;
}

.back-button:hover {
    background-color: #1b4332;
    color: white;
}

.back-button i {
    margin-right: 0.5rem;
}

.evaluation-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.domain-title {
    color: #2d6a4f;
    margin-bottom: 2rem;
    font-size: 2rem;
    font-weight: 600;
}

.evaluation-table {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 1rem;
    border: 1px solid #e0e0e0;
    text-align: left;
}

th {
    background-color: #2d6a4f;
    color: white;
    font-weight: 500;
}

.self-help-col {
    width: 25%;
}

.material-col {
    width: 30%;
}

.eval-col {
    width: 8%;
    text-align: center;
}

.comments-col {
    width: 21%;
}

input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #2d6a4f;
}

.comment-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.total-row {
    font-weight: 600;
    background-color: #f8f9fa;
}

tr:hover {
    background-color: #f8f9fa;
}

@media (max-width: 768px) {
    .back-button {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
    }
    
    .evaluation-container {
        padding: 1rem;
    }
    
    th, td {
        padding: 0.5rem;
        font-size: 0.9rem;
    }
}

td {
    transition: background-color 0.3s ease;
}

tr:last-child td {
    transition: background-color 0.3s ease;
}

.submit-button-container {
    margin-top: 2rem;
    text-align: center;
}

.submit-button {
    display: inline-flex;
    align-items: center;
    padding: 0.8rem 2rem;
    background-color: #2d6a4f;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 1.1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.submit-button:hover {
    background-color: #1b4332;
}

.submit-button i {
    margin-right: 0.5rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function countCheckedBoxes(columnIndex) {
        let count = 0;
        const rows = document.querySelectorAll('tbody tr:not(:last-child)');
        rows.forEach(row => {
            const checkbox = row.querySelector(`td:nth-child(${columnIndex}) input[type="checkbox"]`);
            if (checkbox && checkbox.checked) {
                count++;
            }
        });
        return count;
    }

    function updateTotalScore() {
        // Get the total row cells
        const totalRow = document.querySelector('tbody tr:last-child');
        
        // Count and update for each evaluation column
        const firstEvalTotal = countCheckedBoxes(3);  // 3rd column (1st Eval)
        const secondEvalTotal = countCheckedBoxes(4); // 4th column (2nd Eval)
        const thirdEvalTotal = countCheckedBoxes(5);  // 5th column (3rd Eval)

        // Update the total cells
        totalRow.cells[2].textContent = firstEvalTotal;
        totalRow.cells[3].textContent = secondEvalTotal;
        totalRow.cells[4].textContent = thirdEvalTotal;

        // Add animation effect
        [2, 3, 4].forEach(index => {
            totalRow.cells[index].style.backgroundColor = '#e8f5e9';
            setTimeout(() => {
                totalRow.cells[index].style.backgroundColor = '';
            }, 500);
        });
    }

    // Add event listeners to checkboxes
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Highlight the cell when checked
            const cell = this.parentElement;
            cell.style.backgroundColor = this.checked ? '#e8f5e9' : '';
            
            // Update the totals
            updateTotalScore();
        });
    });

    // Initialize totals on page load
    updateTotalScore();
    
    // Updated submission function
    document.querySelector('.submit-button').addEventListener('click', function() {
        // Get the total scores
        const totalRow = document.querySelector('tbody tr:last-child');
        const eval1Score = parseInt(totalRow.cells[2].textContent) || 0;
        const eval2Score = parseInt(totalRow.cells[3].textContent) || 0;
        const eval3Score = parseInt(totalRow.cells[4].textContent) || 0;
        
        // Get student ID and name from hidden input fields
        const studentId = document.getElementById('student-id') ? document.getElementById('student-id').value : '';
        const studentName = document.getElementById('student-name') ? document.getElementById('student-name').value : '';
        
        // Create form data
        const formData = new FormData();
        formData.append('student_id', studentId);
        formData.append('student_name', studentName);
        formData.append('eval1_score', eval1Score);
        formData.append('eval2_score', eval2Score);
        formData.append('eval3_score', eval3Score);
        
        // Collect comments
        const comments = [];
        document.querySelectorAll('.comment-input').forEach(function(input, index) {
            if (input.value.trim() !== '') {
                comments.push({
                    item: index + 1,
                    comment: input.value.trim()
                });
            }
        });
        
        if (comments.length > 0) {
            formData.append('comments', JSON.stringify(comments));
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Add visual feedback
        const submitButton = document.querySelector('.submit-button');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitButton.disabled = true;
        
        // Submit the data
        fetch('{% url "parent_evaluation_self" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            submitButton.disabled = false;
            if (response.ok) {
                return response.json().then(data => {
                    submitButton.innerHTML = '<i class="fas fa-check"></i> Saved!';
                    setTimeout(() => {
                        alert('Self-Help evaluation saved successfully!');
                        window.location.href = '{% url "dashboard" %}';
                    }, 500);
                });
            } else {
                submitButton.innerHTML = originalText;
                return response.json().then(data => {
                    throw new Error(data.message || 'Error saving evaluation');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
            alert(error.message || 'Error saving evaluation. Please try again.');
        });
    });
});
</script>

<!-- Add CSRF Token -->
{% csrf_token %}

<!-- Add hidden fields for student information -->
{% if student %}
<input type="hidden" id="student-id" value="{{ student.id }}">
<input type="hidden" id="student-name" value="{{ student.child_name }}">
{% else %}
<input type="hidden" id="student-id" value="">
<input type="hidden" id="student-name" value="Unknown Student">
{% endif %}

{% endblock %} 